<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- Prevent caching -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Springfield General Hospital Patient Search</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <h1>Springfield General Hospital Patient Search</h1>
  </header>
  <main style="display: flex; gap: 20px; max-width: 1000px; margin: 20px auto;">
    <section id="add-patient" style="flex: 1.2;">
      <h2>Add New Patient</h2>
      <form id="add-patient-form" action="/add-patient" method="post" autocomplete="off">
        <div>
          <label>First Name:</label>
          <input type="text" id="first-name" name="firstName" required autocomplete="off">
        </div>
        <div>
          <label>Last Name:</label>
          <input type="text" id="last-name" name="lastName" required autocomplete="off">
        </div>
        <div>
          <label>Date of Birth (YYYY-MM-DD):</label>
          <input type="text" id="dob" name="dateOfBirth" required placeholder="e.g. 1985-04-23" autocomplete="off">
        </div>
        <div>
          <label>Zip Code:</label>
          <input type="text" id="zip" name="zipCode" required pattern="\d{5}" title="Please enter a 5-digit zip code." autocomplete="off">
        </div>
        <div>
          <button type="submit">Add Patient</button>
        </div>
      </form>
    </section>
    <section id="search-patient" style="flex: 1.2;">
      <h2>Search Patients</h2>
      <form id="search-patient-form" autocomplete="off">
        <div>
          <label>First Name:</label>
          <input type="text" id="search-first-name" name="firstName" autocomplete="off">
        </div>
        <div>
          <label>Last Name:</label>
          <input type="text" id="search-last-name" name="lastName" autocomplete="off">
        </div>
        <div>
          <label>Year of Birth:</label>
          <input type="number" id="search-yob" name="yearOfBirth" min="1900" max="2099" autocomplete="off">
        </div>
        <div>
          <label>Zip Code:</label>
          <input type="text" id="search-zip" name="zipCode" pattern="\d{5}" title="Please enter a 5-digit zip code." autocomplete="off">
        </div>
        <div>
          <button type="submit">Search</button>
        </div>
      </form>
    </section>
  </main>

  <!-- Search Results Section -->
  <section id="search-results" style="max-width: 1000px; margin: 20px auto;">
    <h2>Search Results</h2>
    <table id="results-table" style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th style="border: 1px solid #ccc; padding: 8px;">First Name</th>
          <th style="border: 1px solid #ccc; padding: 8px;">Last Name</th>
          <th style="border: 1px solid #ccc; padding: 8px;">Date of Birth</th>
          <th style="border: 1px solid #ccc; padding: 8px;">Zip Code</th>
        </tr>
      </thead>
      <tbody>
        <!-- Dynamic rows will be inserted here -->
      </tbody>
    </table>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const searchForm = document.getElementById('search-patient-form');
      const resultsBody = document.querySelector('#results-table tbody');
      let debounceTimer;

      // Core search execution
      const executeSearch = () => {
        const fn = document.getElementById('search-first-name').value.trim();
        const ln = document.getElementById('search-last-name').value.trim();
        const yob = document.getElementById('search-yob').value.trim();
        const zip = document.getElementById('search-zip').value.trim();

        // Criteria: first or last name >=3 chars, or full DOB or full zip
        const criteria = {};
        if (fn.length >= 3) criteria.firstName = fn;
        if (ln.length >= 3) criteria.lastName = ln;
        if (/^\d{4}-\d{2}-\d{2}$/.test(document.getElementById('dob').value)) {
          // For autocomplete, include date of birth if fully entered in add form
          criteria.dateOfBirth = document.getElementById('dob').value.trim();
        }
        if (zip.length === 5) criteria.zipCode = zip;
        if (yob.length === 4) criteria.yearOfBirth = yob;

        // Must have at least one
        if (Object.keys(criteria).length === 0) {
          resultsBody.innerHTML = '';
          return;
        }

        const params = new URLSearchParams();
        Object.entries(criteria).forEach(([key, val]) => params.append(key, val));

        fetch('/search?' + params.toString())
          .then(res => res.ok ? res.json() : Promise.reject('Network response not ok'))
          .then(data => {
            resultsBody.innerHTML = '';
            if (!data.length) {
              const tr = document.createElement('tr');
              const td = document.createElement('td');
              td.colSpan = 4; td.textContent = 'No patients found.'; td.style.textAlign = 'center';
              tr.appendChild(td); resultsBody.appendChild(tr);
              return;
            }
            data.forEach(p => {
              const tr = document.createElement('tr');
              ['firstName','lastName','dateOfBirth','zipCode'].forEach(key => {
                const td = document.createElement('td');
                td.textContent = p[key] || '';
                td.style.border = '1px solid #ccc'; td.style.padding = '8px';
                tr.appendChild(td);
              });
              resultsBody.appendChild(tr);
            });
          })
          .catch(err => console.error('Autocomplete error:', err));
      };

      // Attach input listeners with debounce
      ['search-first-name','search-last-name','search-yob','search-zip'].forEach(id => {
        document.getElementById(id).addEventListener('input', () => {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(executeSearch, 300);
        });
      });

      // Keep form submit for explicit search
      searchForm.addEventListener('submit', e => {
        e.preventDefault();
        executeSearch();
      });
    });
  </script>
</body>
</html>
